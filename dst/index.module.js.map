{"version":3,"file":"index.module.js","sources":["../src/api.js","../src/storage.js","../src/session.js","../src/auth.js","../src/login.js"],"sourcesContent":["import jwt from 'jsonwebtoken'\nimport safeCompare from 'safe-compare'\n\nconst api = ({ secret, users, expiration = '1h' }) => {\n  const handler = (req, res) => {\n    if (req.method === 'POST') {\n      const user = users.find((d) => safeCompare(d.password, req.body.password))\n      if (user) {\n        const token = jwt.sign({ username: user.username }, secret, {\n          expiresIn: expiration,\n        })\n        res.status(200).json({ username: user.username, token: token })\n      } else {\n        res.status(403).json({ message: 'password not recognized' })\n      }\n    }\n\n    if (req.method === 'GET') {\n      if (process.env.AUTH_OVERRIDE) {\n        res.status(200).json({ username: 'admin', authed: true })\n      } else {\n        const token = req.headers.authorization\n        try {\n          var decoded = jwt.verify(token, secret)\n          res.status(200).json({ username: decoded.username, authed: true })\n        } catch (err) {\n          res.status(403).json({ authed: false })\n        }\n      }\n    }\n  }\n\n  return handler\n}\n\nexport default api\n","const TOKEN_KEY = 'zalxon-auth-token'\n\nexport const storage = {\n  get: () => {\n    try {\n      return window.localStorage.getItem(TOKEN_KEY)\n    } catch (err) {\n      if (err.message !== 'window is not defined')\n        console.warn(\n          'localStorage is disabled so cannot be used to persist token',\n          err\n        )\n    }\n  },\n  set: (value) => {\n    try {\n      window.localStorage.setItem(TOKEN_KEY, value)\n    } catch (err) {\n      if (err.message !== 'window is not defined')\n        console.warn(\n          'localStorage is disabled so cannot be used to persist token',\n          err\n        )\n    }\n  },\n  remove: () => {\n    try {\n      window.localStorage.removeItem(TOKEN_KEY)\n    } catch (err) {\n      if (err.message !== 'window is not defined')\n        console.warn(\n          'localStorage is disabled so cannot be used to persist token',\n          err\n        )\n    }\n  },\n}\n","import React, { useState, createContext, useContext } from 'react'\nimport { storage } from './storage'\n\nconst Session = createContext(null)\n\nexport const useSession = () => {\n  return useContext(Session)\n}\n\nexport const SessionProvider = ({\n  children,\n  config = { useLocalStorage: false },\n}) => {\n  const [session, setSession] = useState({\n    token: null,\n    username: null,\n    config: config,\n  })\n\n  if (config.useLocalStorage === false) {\n    storage.remove()\n  }\n\n  return (\n    <Session.Provider value={[session, setSession]}>\n      {children}\n    </Session.Provider>\n  )\n}\n","import useSWR from 'swr'\nimport React, { useState, useEffect, createContext, useContext } from 'react'\nimport { useRouter } from 'next/router.js'\nimport { Layout } from '@zalxon/components'\nimport { useSession } from './session'\nimport { storage } from './storage'\n\nexport function useAuth() {\n  const router = useRouter()\n  const [{ token, config }] = useSession()\n\n  let auth\n  if (config.useLocalStorage) {\n    auth = token || storage.get()\n  } else {\n    auth = token\n  }\n\n  const fetcher = (url, token) =>\n    fetch(url, { headers: { Authorization: auth } }).then((r) => r.json())\n\n  const { data, error } = useSWR(['/api/auth', auth], fetcher)\n  const loading = !data && !error\n  const authed = data && data.authed\n  const username = data && data.authed ? data.username : null\n\n  return { data, error, loading, authed, username }\n}\n\nexport const withAuth =\n  (Component, usernames = ['admin']) =>\n  (props) => {\n    const router = useRouter()\n    const [{ config }] = useSession()\n    const { data, error, loading } = useAuth()\n\n    useEffect(() => {\n      if ((data && !data.authed) || error) {\n        if (config.useLocalStorage) storage.remove()\n        window.location.assign(\n          `/login?redirect=${encodeURIComponent(router.asPath)}`\n        )\n      }\n    }, [data])\n\n    if (data && data.username) {\n      if (!usernames.includes(data.username)) {\n        data.authed = false\n        return (\n          <Layout\n            title='Zalxon – Login'\n            description='Login page for authenticated resource'\n            status={'restricted'}\n          ></Layout>\n        )\n      }\n    }\n\n    if (data && data.authed) {\n      return <Component {...props} />\n    } else {\n      return (\n        <Layout\n          title='Zalxon – Login'\n          description='Login page for authenticated resource'\n          footer={false}\n          status={'authenticating'}\n        ></Layout>\n      )\n    }\n  }\n","import React, { useState, useEffect } from 'react'\nimport { Box, Text, Heading, Input, Button } from 'theme-ui'\nimport { useRouter } from 'next/router.js'\nimport { Layout, Row, Column } from '@zalxon/components'\nimport { useSession } from './session'\nimport { storage } from './storage'\n\nconst Login = ({ origin }) => {\n  const router = useRouter()\n  const [{ config }, setSession] = useSession()\n  const [status, setStatus] = useState(null)\n  const [password, setPassword] = useState('')\n\n  const { redirect } = router.query\n\n  const disabled = ['authenticating', 'submitting'].includes(status)\n\n  useEffect(() => {\n    if (config.useLocalStorage) {\n      const auth = storage.get()\n      if (auth && redirect) {\n        router.push(redirect)\n      }\n    }\n  }, [redirect, config.useLocalStorage])\n\n  async function submit(e) {\n    setStatus('submitting')\n    e.preventDefault()\n    const res = await fetch('/api/auth', {\n      method: 'POST',\n      body: JSON.stringify({ password: password }),\n      headers: {\n        'Content-Type': 'application/json',\n      },\n    })\n    if (res.status !== 200) {\n      setStatus('invalid')\n      setTimeout(() => {\n        setStatus(null)\n      }, 1000)\n    } else {\n      const { username, token } = await res.json()\n      setSession({ token: token, username: username, config: config })\n      if (config.useLocalStorage) storage.set(token)\n      setStatus('authenticating')\n      if (redirect) {\n        router.push(redirect)\n      } else {\n        router.push('/')\n      }\n    }\n  }\n\n  return (\n    <Layout\n      status={status}\n      footer={false}\n      title='Zalxon – Login'\n      description='Login page for authenticated resource'\n    >\n      <Row sx={{ mt: [5] }}>\n        <Column start={[1, 2]} width={[6, 6]}>\n          <Heading sx={{ my: [4, 5, 5], fontSize: [6, 7, 7] }}>\n            This page is private\n          </Heading>\n          <Text sx={{ my: [3, 4, 4], fontSize: [4, 5, 5] }}>\n            Enter a password to continue\n          </Text>\n          <Box as='form' onSubmit={submit} sx={{ fontSize: [4], mb: [4] }}>\n            <Input\n              sx={{\n                width: ['200px'],\n                mt: [2],\n                borderStyle: 'solid',\n                borderWidth: '0px',\n                borderBottomWidth: '1px',\n                borderColor: 'secondary',\n                borderRadius: '0px',\n                transition: '0.15s',\n                ':focus-visible': {\n                  outline: 'none !important',\n                  background: 'none !important',\n                  borderColor: 'primary',\n                },\n              }}\n              type='password'\n              name='password'\n              id='password'\n              value={password}\n              placeholder='Password?'\n              autoFocus={true}\n              onChange={(e) => {\n                setPassword(e.target.value)\n              }}\n            />\n            <Button\n              disabled={disabled}\n              onClick={submit}\n              type='submit'\n              sx={{\n                fontFamily: 'faux',\n                color: 'text',\n                display: 'inline-block',\n                mr: [3],\n                fontSize: [7],\n                mt: [2],\n                cursor: 'pointer',\n                '&:hover': {\n                  color: disabled ? 'primary' : 'secondary',\n                },\n                background: 'none',\n                p: [0],\n              }}\n            >\n              →\n            </Button>\n          </Box>\n        </Column>\n      </Row>\n    </Layout>\n  )\n}\n\nexport default Login\n"],"names":["api","_ref","secret","users","_ref$expiration","expiration","req","res","method","user","find","d","safeCompare","password","body","token","jwt","sign","username","expiresIn","status","json","message","process","env","AUTH_OVERRIDE","authed","_token","headers","authorization","decoded","verify","err","storage","window","localStorage","getItem","console","warn","removeItem","Session","createContext","useSession","useContext","children","config","_ref$config","useLocalStorage","useState","session","_useState","setSession","React","createElement","Provider","value","useRouter","auth","_useSession$","useSWR","url","fetch","Authorization","then","r","data","_useSWR","error","loading","withAuth","Component","usernames","props","useAuth","useEffect","location","assign","encodeURIComponent","router","asPath","includes","Layout","title","description","footer","Login","submit","e","setStatus","preventDefault","JSON","stringify","_temp","Promise","resolve","_ref2","setItem","push","redirect","setTimeout","reject","setPassword","_useState2","query","disabled","Row","sx","mt","Column","start","width","Heading","my","fontSize","Text","Box","as","onSubmit","mb","Input","borderStyle","borderWidth","borderBottomWidth","borderColor","borderRadius","transition","outline","background","type","name","id","placeholder","autoFocus","onChange","target","Button","onClick","fontFamily","color","display","mr","cursor","p"],"mappings":"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"}