var e=require("jsonwebtoken"),t=require("safe-compare"),n=require("swr"),o=require("react"),r=require("next/router.js"),a=require("@zalxon/components"),u=require("theme-ui");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=/*#__PURE__*/s(e),c=/*#__PURE__*/s(t),d=/*#__PURE__*/s(n),l=/*#__PURE__*/s(o),f=function(){try{return window.localStorage.getItem("zalxon-auth-token")}catch(e){"window is not defined"!==e.message&&console.warn("localStorage is disabled so cannot be used to persist token",e)}},m=function(){try{window.localStorage.removeItem("zalxon-auth-token")}catch(e){"window is not defined"!==e.message&&console.warn("localStorage is disabled so cannot be used to persist token",e)}},h=o.createContext(null),p=function(){return o.useContext(h)};function g(){r.useRouter();var e,t=p()[0],n=t.token;e=t.config.useLocalStorage?n||f():n;var o=d.default(["/api/auth",e],function(t,n){return fetch(t,{headers:{Authorization:e}}).then(function(e){return e.json()})}),a=o.data,u=o.error;return{data:a,error:u,loading:!a&&!u,authed:a&&a.authed,username:a&&a.authed?a.username:null}}exports.AuthProvider=function(e){var t=e.children,n=e.config,r=void 0===n?{useLocalStorage:!1}:n,a=o.useState({token:null,username:null,config:r}),u=a[0],s=a[1];return!1===r.useLocalStorage&&m(),/*#__PURE__*/l.default.createElement(h.Provider,{value:[u,s]},t)},exports.Login=function(e){var t=function(e){try{return h("submitting"),e.preventDefault(),Promise.resolve(fetch("/api/auth",{method:"POST",body:JSON.stringify({password:v}),headers:{"Content-Type":"application/json"}})).then(function(e){var t=function(){if(200===e.status)return Promise.resolve(e.json()).then(function(e){var t=e.token;c({token:t,username:e.username,config:i}),i.useLocalStorage&&function(e){try{window.localStorage.setItem("zalxon-auth-token",e)}catch(e){"window is not defined"!==e.message&&console.warn("localStorage is disabled so cannot be used to persist token",e)}}(t),h("authenticating"),n.push(x||"/")});h("invalid"),setTimeout(function(){h(null)},1e3)}();if(t&&t.then)return t.then(function(){})})}catch(e){return Promise.reject(e)}},n=r.useRouter(),s=p(),i=s[0].config,c=s[1],d=o.useState(null),m=d[0],h=d[1],g=o.useState(""),v=g[0],w=g[1],x=n.query.redirect,b=["authenticating","submitting"].includes(m);return o.useEffect(function(){i.useLocalStorage&&f()&&x&&n.push(x)},[x,i.useLocalStorage]),/*#__PURE__*/l.default.createElement(a.Layout,{status:m,footer:!1,title:"Zalxon – Login",description:"Login page for authenticated resource"},/*#__PURE__*/l.default.createElement(a.Row,{sx:{mt:[5]}},/*#__PURE__*/l.default.createElement(a.Column,{start:[1,2],width:[6,6]},/*#__PURE__*/l.default.createElement(u.Heading,{sx:{my:[4,5,5],fontSize:[6,7,7]}},"This page is private"),/*#__PURE__*/l.default.createElement(u.Text,{sx:{my:[3,4,4],fontSize:[4,5,5]}},"Enter a password to continue"),/*#__PURE__*/l.default.createElement(u.Box,{as:"form",onSubmit:t,sx:{fontSize:[4],mb:[4]}},/*#__PURE__*/l.default.createElement(u.Input,{sx:{width:["200px"],mt:[2],borderStyle:"solid",borderWidth:"0px",borderBottomWidth:"1px",borderColor:"secondary",borderRadius:"0px",transition:"0.15s",":focus-visible":{outline:"none !important",background:"none !important",borderColor:"primary"}},type:"password",name:"password",id:"password",value:v,placeholder:"Password?",autoFocus:!0,onChange:function(e){w(e.target.value)}}),/*#__PURE__*/l.default.createElement(u.Button,{disabled:b,onClick:t,type:"submit",sx:{fontFamily:"faux",color:"text",display:"inline-block",mr:[3],fontSize:[7],mt:[2],cursor:"pointer","&:hover":{color:b?"primary":"secondary"},background:"none",p:[0]}},"→")))))},exports.api=function(e){var t=e.secret,n=e.users,o=e.expiration,r=void 0===o?"1h":o;return function(e,o){if("POST"===e.method){var a=n.find(function(t){return c.default(t.password,e.body.password)});if(a){var u=i.default.sign({username:a.username},t,{expiresIn:r});o.status(200).json({username:a.username,token:u})}else o.status(403).json({message:"password not recognized"})}if("GET"===e.method)if(process.env.AUTH_OVERRIDE)o.status(200).json({username:"admin",authed:!0});else{var s=e.headers.authorization;try{var d=i.default.verify(s,t);o.status(200).json({username:d.username,authed:!0})}catch(e){o.status(403).json({authed:!1})}}}},exports.useAuth=g,exports.withAuth=function(e,t){return void 0===t&&(t=["admin"]),function(n){var u=r.useRouter(),s=p()[0].config,i=g(),c=i.data,d=i.error;return o.useEffect(function(){(c&&!c.authed||d)&&(s.useLocalStorage&&m(),window.location.assign("/login?redirect="+encodeURIComponent(u.asPath)))},[c]),c&&c.username&&!t.includes(c.username)?(c.authed=!1,/*#__PURE__*/l.default.createElement(a.Layout,{title:"Zalxon – Login",description:"Login page for authenticated resource",status:"restricted"})):c&&c.authed?/*#__PURE__*/l.default.createElement(e,n):/*#__PURE__*/l.default.createElement(a.Layout,{title:"Zalxon – Login",description:"Login page for authenticated resource",footer:!1,status:"authenticating"})}};
//# sourceMappingURL=index.cjs.map
