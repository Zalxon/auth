{"version":3,"file":"index.modern.js","sources":["../src/api.js","../src/storage.js","../src/session.js","../src/auth.js","../src/login.js"],"sourcesContent":["import jwt from 'jsonwebtoken'\nimport safeCompare from 'safe-compare'\n\nconst api = ({ secret, users, expiration = '1h' }) => {\n  const handler = (req, res) => {\n    if (req.method === 'POST') {\n      const user = users.find((d) => safeCompare(d.password, req.body.password))\n      if (user) {\n        const token = jwt.sign({ username: user.username }, secret, {\n          expiresIn: expiration,\n        })\n        res.status(200).json({ username: user.username, token: token })\n      } else {\n        res.status(403).json({ message: 'password not recognized' })\n      }\n    }\n\n    if (req.method === 'GET') {\n      if (process.env.AUTH_OVERRIDE) {\n        res.status(200).json({ username: 'admin', authed: true })\n      } else {\n        const token = req.headers.authorization\n        try {\n          var decoded = jwt.verify(token, secret)\n          res.status(200).json({ username: decoded.username, authed: true })\n        } catch (err) {\n          res.status(403).json({ authed: false })\n        }\n      }\n    }\n  }\n\n  return handler\n}\n\nexport default api\n","const TOKEN_KEY = 'zalxon-auth-token'\n\nexport const storage = {\n  get: () => {\n    try {\n      return window.localStorage.getItem(TOKEN_KEY)\n    } catch (err) {\n      if (err.message !== 'window is not defined')\n        console.warn(\n          'localStorage is disabled so cannot be used to persist token',\n          err\n        )\n    }\n  },\n  set: (value) => {\n    try {\n      window.localStorage.setItem(TOKEN_KEY, value)\n    } catch (err) {\n      if (err.message !== 'window is not defined')\n        console.warn(\n          'localStorage is disabled so cannot be used to persist token',\n          err\n        )\n    }\n  },\n  remove: () => {\n    try {\n      window.localStorage.removeItem(TOKEN_KEY)\n    } catch (err) {\n      if (err.message !== 'window is not defined')\n        console.warn(\n          'localStorage is disabled so cannot be used to persist token',\n          err\n        )\n    }\n  },\n}\n","import React, { useState, createContext, useContext } from 'react'\nimport { storage } from './storage'\n\nconst Session = createContext(null)\n\nexport const useSession = () => {\n  return useContext(Session)\n}\n\nexport const SessionProvider = ({\n  children,\n  config = { useLocalStorage: false },\n}) => {\n  const [session, setSession] = useState({\n    token: null,\n    username: null,\n    config: config,\n  })\n\n  if (config.useLocalStorage === false) {\n    storage.remove()\n  }\n\n  return (\n    <Session.Provider value={[session, setSession]}>\n      {children}\n    </Session.Provider>\n  )\n}\n","import useSWR from 'swr'\nimport React, { useState, useEffect, createContext, useContext } from 'react'\nimport { useRouter } from 'next/router.js'\nimport { Layout } from '@zalxon/components'\nimport { useSession } from './session'\nimport { storage } from './storage'\n\nexport function useAuth() {\n  const router = useRouter()\n  const [{ token, config }] = useSession()\n\n  let auth\n  if (config.useLocalStorage) {\n    auth = token || storage.get()\n  } else {\n    auth = token\n  }\n\n  const fetcher = (url, token) =>\n    fetch(url, { headers: { Authorization: auth } }).then((r) => r.json())\n\n  const { data, error } = useSWR(['/api/auth', auth], fetcher)\n  const loading = !data && !error\n  const authed = data && data.authed\n  const username = data && data.authed ? data.username : null\n\n  return { data, error, loading, authed, username }\n}\n\nexport const withAuth =\n  (Component, usernames = ['admin']) =>\n  (props) => {\n    const router = useRouter()\n    const [{ config }] = useSession()\n    const { data, error, loading } = useAuth()\n\n    useEffect(() => {\n      if ((data && !data.authed) || error) {\n        if (config.useLocalStorage) storage.remove()\n        window.location.assign(\n          `/login?redirect=${encodeURIComponent(router.asPath)}`\n        )\n      }\n    }, [data])\n\n    if (data && data.username) {\n      if (!usernames.includes(data.username)) {\n        data.authed = false\n        return (\n          <Layout\n            title='Zalxon – Login'\n            description='Login page for authenticated resource'\n            status={'restricted'}\n          ></Layout>\n        )\n      }\n    }\n\n    if (data && data.authed) {\n      return <Component {...props} />\n    } else {\n      return (\n        <Layout\n          title='Zalxon – Login'\n          description='Login page for authenticated resource'\n          footer={false}\n          status={'authenticating'}\n        ></Layout>\n      )\n    }\n  }\n","import React, { useState, useEffect } from 'react'\nimport { Box, Text, Heading, Input, Button } from 'theme-ui'\nimport { useRouter } from 'next/router.js'\nimport { Layout, Row, Column } from '@zalxon/components'\nimport { useSession } from './session'\nimport { storage } from './storage'\n\nconst Login = ({ origin }) => {\n  const router = useRouter()\n  const [{ config }, setSession] = useSession()\n  const [status, setStatus] = useState(null)\n  const [password, setPassword] = useState('')\n\n  const { redirect } = router.query\n\n  const disabled = ['authenticating', 'submitting'].includes(status)\n\n  useEffect(() => {\n    if (config.useLocalStorage) {\n      const auth = storage.get()\n      if (auth && redirect) {\n        router.push(redirect)\n      }\n    }\n  }, [redirect, config.useLocalStorage])\n\n  async function submit(e) {\n    setStatus('submitting')\n    e.preventDefault()\n    const res = await fetch('/api/auth', {\n      method: 'POST',\n      body: JSON.stringify({ password: password }),\n      headers: {\n        'Content-Type': 'application/json',\n      },\n    })\n    if (res.status !== 200) {\n      setStatus('invalid')\n      setTimeout(() => {\n        setStatus(null)\n      }, 1000)\n    } else {\n      const { username, token } = await res.json()\n      setSession({ token: token, username: username, config: config })\n      if (config.useLocalStorage) storage.set(token)\n      setStatus('authenticating')\n      if (redirect) {\n        router.push(redirect)\n      } else {\n        router.push('/')\n      }\n    }\n  }\n\n  return (\n    <Layout\n      status={status}\n      footer={false}\n      title='Zalxon – Login'\n      description='Login page for authenticated resource'\n    >\n      <Row sx={{ mt: [5] }}>\n        <Column start={[1, 2]} width={[6, 6]}>\n          <Heading sx={{ my: [4, 5, 5], fontSize: [6, 7, 7] }}>\n            This page is private\n          </Heading>\n          <Text sx={{ my: [3, 4, 4], fontSize: [4, 5, 5] }}>\n            Enter a password to continue\n          </Text>\n          <Box as='form' onSubmit={submit} sx={{ fontSize: [4], mb: [4] }}>\n            <Input\n              sx={{\n                width: ['200px'],\n                mt: [2],\n                borderStyle: 'solid',\n                borderWidth: '0px',\n                borderBottomWidth: '1px',\n                borderColor: 'secondary',\n                borderRadius: '0px',\n                transition: '0.15s',\n                ':focus-visible': {\n                  outline: 'none !important',\n                  background: 'none !important',\n                  borderColor: 'primary',\n                },\n              }}\n              type='password'\n              name='password'\n              id='password'\n              value={password}\n              placeholder='Password?'\n              autoFocus={true}\n              onChange={(e) => {\n                setPassword(e.target.value)\n              }}\n            />\n            <Button\n              disabled={disabled}\n              onClick={submit}\n              type='submit'\n              sx={{\n                fontFamily: 'faux',\n                color: 'text',\n                display: 'inline-block',\n                mr: [3],\n                fontSize: [7],\n                mt: [2],\n                cursor: 'pointer',\n                '&:hover': {\n                  color: disabled ? 'primary' : 'secondary',\n                },\n                background: 'none',\n                p: [0],\n              }}\n            >\n              →\n            </Button>\n          </Box>\n        </Column>\n      </Row>\n    </Layout>\n  )\n}\n\nexport default Login\n"],"names":["api","secret","users","expiration","req","res","method","user","find","d","safeCompare","password","body","token","jwt","sign","username","expiresIn","status","json","message","process","env","AUTH_OVERRIDE","authed","headers","authorization","decoded","verify","err","storage","window","localStorage","getItem","console","warn","removeItem","Session","createContext","useSession","useContext","SessionProvider","children","config","useLocalStorage","session","setSession","useState","React","createElement","Provider","value","useRouter","auth","data","error","useSWR","url","fetch","Authorization","then","r","loading","withAuth","Component","usernames","props","router","useAuth","useEffect","location","assign","encodeURIComponent","asPath","includes","Layout","title","description","footer","Login","setStatus","setPassword","redirect","query","disabled","async","submit","e","preventDefault","JSON","stringify","setTimeout","setItem","push","Row","sx","mt","Column","start","width","Heading","my","fontSize","Text","Box","as","onSubmit","mb","Input","borderStyle","borderWidth","borderBottomWidth","borderColor","borderRadius","transition","outline","background","type","name","id","placeholder","autoFocus","onChange","target","Button","onClick","fontFamily","color","display","mr","cursor","p"],"mappings":"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"}