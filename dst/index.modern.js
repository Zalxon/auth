import e from"jsonwebtoken";import t from"safe-compare";import o from"swr";import n,{createContext as a,useState as r,useContext as s,useEffect as i}from"react";import{useRouter as c}from"next/router.js";import{Layout as u,Row as d,Column as l}from"@zalxon/components";import{Heading as m,Text as p,Box as h,Input as g,Button as f}from"theme-ui";const w=({secret:o,users:n,expiration:a="1h"})=>(r,s)=>{if("POST"===r.method){const i=n.find(e=>t(e.password,r.body.password));if(i){const t=e.sign({username:i.username},o,{expiresIn:a});s.status(200).json({username:i.username,token:t})}else s.status(403).json({message:"password not recognized"})}if("GET"===r.method)if(process.env.AUTH_OVERRIDE)s.status(200).json({username:"admin",authed:!0});else{const t=r.headers.authorization;try{var i=e.verify(t,o);s.status(200).json({username:i.username,authed:!0})}catch(e){s.status(403).json({authed:!1})}}},b=()=>{try{return window.localStorage.getItem("zalxon-auth-token")}catch(e){"window is not defined"!==e.message&&console.warn("localStorage is disabled so cannot be used to persist token",e)}},x=()=>{try{window.localStorage.removeItem("zalxon-auth-token")}catch(e){"window is not defined"!==e.message&&console.warn("localStorage is disabled so cannot be used to persist token",e)}},y=a(null),S=()=>s(y),k=({children:e,config:t={useLocalStorage:!1}})=>{const[o,a]=r({token:null,username:null,config:t});return!1===t.useLocalStorage&&x(),/*#__PURE__*/n.createElement(y.Provider,{value:[o,a]},e)};function E(){c();const[{token:e,config:t}]=S();let n;n=t.useLocalStorage?e||b():e;const{data:a,error:r}=o(["/api/auth",n],(e,t)=>fetch(e,{headers:{Authorization:n}}).then(e=>e.json()));return{data:a,error:r,loading:!a&&!r,authed:a&&a.authed,username:a&&a.authed?a.username:null}}const v=(e,t=["admin"])=>o=>{const a=c(),[{config:r}]=S(),{data:s,error:d}=E();return i(()=>{(s&&!s.authed||d)&&(r.useLocalStorage&&x(),window.location.assign(`/login?redirect=${encodeURIComponent(a.asPath)}`))},[s]),s&&s.username&&!t.includes(s.username)?(s.authed=!1,/*#__PURE__*/n.createElement(u,{title:"Zalxon – Login",description:"Login page for authenticated resource",status:"restricted"})):s&&s.authed?/*#__PURE__*/n.createElement(e,o):/*#__PURE__*/n.createElement(u,{title:"Zalxon – Login",description:"Login page for authenticated resource",footer:!1,status:"authenticating"})},L=({})=>{const e=c(),[{config:t},o]=S(),[a,s]=r(null),[w,x]=r(""),{redirect:y}=e.query,k=["authenticating","submitting"].includes(a);async function E(n){s("submitting"),n.preventDefault();const a=await fetch("/api/auth",{method:"POST",body:JSON.stringify({password:w}),headers:{"Content-Type":"application/json"}});if(200!==a.status)s("invalid"),setTimeout(()=>{s(null)},1e3);else{const{username:n,token:r}=await a.json();o({token:r,username:n,config:t}),t.useLocalStorage&&(e=>{try{window.localStorage.setItem("zalxon-auth-token",e)}catch(e){"window is not defined"!==e.message&&console.warn("localStorage is disabled so cannot be used to persist token",e)}})(r),s("authenticating"),e.push(y||"/")}}return i(()=>{t.useLocalStorage&&b()&&y&&e.push(y)},[y,t.useLocalStorage]),/*#__PURE__*/n.createElement(u,{status:a,footer:!1,title:"Zalxon – Login",description:"Login page for authenticated resource"},/*#__PURE__*/n.createElement(d,{sx:{mt:[5]}},/*#__PURE__*/n.createElement(l,{start:[1,2],width:[6,6]},/*#__PURE__*/n.createElement(m,{sx:{my:[4,5,5],fontSize:[6,7,7]}},"This page is private"),/*#__PURE__*/n.createElement(p,{sx:{my:[3,4,4],fontSize:[4,5,5]}},"Enter a password to continue"),/*#__PURE__*/n.createElement(h,{as:"form",onSubmit:E,sx:{fontSize:[4],mb:[4]}},/*#__PURE__*/n.createElement(g,{sx:{width:["200px"],mt:[2],borderStyle:"solid",borderWidth:"0px",borderBottomWidth:"1px",borderColor:"secondary",borderRadius:"0px",transition:"0.15s",":focus-visible":{outline:"none !important",background:"none !important",borderColor:"primary"}},type:"password",name:"password",id:"password",value:w,placeholder:"Password?",autoFocus:!0,onChange:e=>{x(e.target.value)}}),/*#__PURE__*/n.createElement(f,{disabled:k,onClick:E,type:"submit",sx:{fontFamily:"faux",color:"text",display:"inline-block",mr:[3],fontSize:[7],mt:[2],cursor:"pointer","&:hover":{color:k?"primary":"secondary"},background:"none",p:[0]}},"→")))))};export{k as AuthProvider,L as Login,w as api,E as useAuth,v as withAuth};
//# sourceMappingURL=index.modern.js.map
