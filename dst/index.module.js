import e from"jsonwebtoken";import t from"safe-compare";import o from"swr";import n,{createContext as r,useState as a,useContext as i,useEffect as s}from"react";import{useRouter as u}from"next/router.js";import{Layout as c,Row as d,Column as l}from"@zalxon/components";import{Heading as m,Text as f,Box as h,Input as p,Button as g}from"theme-ui";var v=function(o){var n=o.secret,r=o.users,a=o.expiration,i=void 0===a?"1h":a;return function(o,a){if("POST"===o.method){var s=r.find(function(e){return t(e.password,o.body.password)});if(s){var u=e.sign({username:s.username},n,{expiresIn:i});a.status(200).json({username:s.username,token:u})}else a.status(403).json({message:"password not recognized"})}if("GET"===o.method)if(process.env.AUTH_OVERRIDE)a.status(200).json({username:"admin",authed:!0});else{var c=o.headers.authorization;try{var d=e.verify(c,n);a.status(200).json({username:d.username,authed:!0})}catch(e){a.status(403).json({authed:!1})}}}},w=function(){try{return window.localStorage.getItem("zalxon-auth-token")}catch(e){"window is not defined"!==e.message&&console.warn("localStorage is disabled so cannot be used to persist token",e)}},b=function(){try{window.localStorage.removeItem("zalxon-auth-token")}catch(e){"window is not defined"!==e.message&&console.warn("localStorage is disabled so cannot be used to persist token",e)}},x=r(null),y=function(){return i(x)},S=function(e){var t=e.children,o=e.config,r=void 0===o?{useLocalStorage:!1}:o,i=a({token:null,username:null,config:r}),s=i[0],u=i[1];return!1===r.useLocalStorage&&b(),/*#__PURE__*/n.createElement(x.Provider,{value:[s,u]},t)};function k(){u();var e,t=y()[0],n=t.token;e=t.config.useLocalStorage?n||w():n;var r=o(["/api/auth",e],function(t,o){return fetch(t,{headers:{Authorization:e}}).then(function(e){return e.json()})}),a=r.data,i=r.error;return{data:a,error:i,loading:!a&&!i,authed:a&&a.authed,username:a&&a.authed?a.username:null}}var E=function(e,t){return void 0===t&&(t=["admin"]),function(o){var r=u(),a=y()[0].config,i=k(),d=i.data,l=i.error;return s(function(){(d&&!d.authed||l)&&(a.useLocalStorage&&b(),window.location.assign("/login?redirect="+encodeURIComponent(r.asPath)))},[d]),d&&d.username&&!t.includes(d.username)?(d.authed=!1,/*#__PURE__*/n.createElement(c,{title:"Zalxon – Login",description:"Login page for authenticated resource",status:"restricted"})):d&&d.authed?/*#__PURE__*/n.createElement(e,o):/*#__PURE__*/n.createElement(c,{title:"Zalxon – Login",description:"Login page for authenticated resource",footer:!1,status:"authenticating"})}},L=function(e){var t=function(e){try{return S("submitting"),e.preventDefault(),Promise.resolve(fetch("/api/auth",{method:"POST",body:JSON.stringify({password:E}),headers:{"Content-Type":"application/json"}})).then(function(e){var t=function(){if(200===e.status)return Promise.resolve(e.json()).then(function(e){var t=e.token;v({token:t,username:e.username,config:i}),i.useLocalStorage&&function(e){try{window.localStorage.setItem("zalxon-auth-token",e)}catch(e){"window is not defined"!==e.message&&console.warn("localStorage is disabled so cannot be used to persist token",e)}}(t),S("authenticating"),o.push(j||"/")});S("invalid"),setTimeout(function(){S(null)},1e3)}();if(t&&t.then)return t.then(function(){})})}catch(e){return Promise.reject(e)}},o=u(),r=y(),i=r[0].config,v=r[1],b=a(null),x=b[0],S=b[1],k=a(""),E=k[0],L=k[1],j=o.query.redirect,z=["authenticating","submitting"].includes(x);return s(function(){i.useLocalStorage&&w()&&j&&o.push(j)},[j,i.useLocalStorage]),/*#__PURE__*/n.createElement(c,{status:x,footer:!1,title:"Zalxon – Login",description:"Login page for authenticated resource"},/*#__PURE__*/n.createElement(d,{sx:{mt:[5]}},/*#__PURE__*/n.createElement(l,{start:[1,2],width:[6,6]},/*#__PURE__*/n.createElement(m,{sx:{my:[4,5,5],fontSize:[6,7,7]}},"This page is private"),/*#__PURE__*/n.createElement(f,{sx:{my:[3,4,4],fontSize:[4,5,5]}},"Enter a password to continue"),/*#__PURE__*/n.createElement(h,{as:"form",onSubmit:t,sx:{fontSize:[4],mb:[4]}},/*#__PURE__*/n.createElement(p,{sx:{width:["200px"],mt:[2],borderStyle:"solid",borderWidth:"0px",borderBottomWidth:"1px",borderColor:"secondary",borderRadius:"0px",transition:"0.15s",":focus-visible":{outline:"none !important",background:"none !important",borderColor:"primary"}},type:"password",name:"password",id:"password",value:E,placeholder:"Password?",autoFocus:!0,onChange:function(e){L(e.target.value)}}),/*#__PURE__*/n.createElement(g,{disabled:z,onClick:t,type:"submit",sx:{fontFamily:"faux",color:"text",display:"inline-block",mr:[3],fontSize:[7],mt:[2],cursor:"pointer","&:hover":{color:z?"primary":"secondary"},background:"none",p:[0]}},"→")))))};export{S as AuthProvider,L as Login,v as api,k as useAuth,E as withAuth};
//# sourceMappingURL=index.module.js.map
